name: Build & Push Operator Image

on:
  workflow_dispatch:  # ðŸ‘ˆ å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ› ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ” Detect Changed Operators
        id: detect_changes
        run: |
          echo "Detecting changed operators..."
          git fetch --depth=2
          CHANGED_OPERATORS=$(git diff --name-only HEAD~1 HEAD | grep '^operators/' | awk -F'/' '{print $2}' | sort -u)
          echo "Changed Operators: $CHANGED_OPERATORS"
          echo "changed_operators=${CHANGED_OPERATORS}" >> $GITHUB_ENV

      - name: ðŸ“¦ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ðŸš€ Build & Push Operators
        if: env.changed_operators != ''
        run: |
          for OPERATOR in ${{ env.changed_operators }}; do
            echo "Processing operator: $OPERATOR"

            # ç¡®è®¤ operator.yaml çš„æ ¼å¼æ˜¯å¦æ­£ç¡®
            #echo "Checking operator.yaml format..."
            #cat operators/$OPERATOR/operator.yaml

            # 1ï¸âƒ£ ç”Ÿæˆ requirements.txt
            echo "Generating requirements.txt from operator.yaml..."
            awk '/dependencies:/, /baseImage:/ {if ($0 !~ "dependencies:" && $0 !~ "baseImage:") print $0}' operators/$OPERATOR/operator.yaml | sed 's/^- //g' > operators/$OPERATOR/requirements.txt
            cat operators/$OPERATOR/requirements.txt

            # 2ï¸âƒ£ å®‰è£…ä¾èµ– 
            pip install -r operators/$OPERATOR/requirements.txt

            # 3ï¸âƒ£ Docker ç™»å½•
            echo "${{ secrets.HARBOR_PASSWORD }}" | docker login fairmarket.casdc.cn --username "${{ secrets.HARBOR_USER }}" --password-stdin

            # 4ï¸âƒ£ è¯»å– `operator.yaml`ï¼ŒèŽ·å– OPERATOR_NAME
            OPERATOR_NAME=$(awk '/operatorName:/ {print $NF}' operators/$OPERATOR/operator.yaml)
            echo "Extracted OPERATOR_NAME: $OPERATOR_NAME"

            #- name: ðŸ“ Generate Dockerfile from YAML
            #run: python generate_dockerfile.py operators/${{ env.OPERATOR_NAME }}/operator.yaml operators/${{ env.OPERATOR_NAME }}/Dockerfile

            # 5ï¸âƒ£ æž„å»º & æŽ¨é€ Docker é•œåƒ
            # è¯»å– operator.yaml ä¸­çš„ version å­—æ®µ
            VERSION=$(awk -F': ' '/version:/ {print $2}' operators/$OPERATOR/operator.yaml | tr -d '"')
            
            # ç¡®ä¿ version å˜é‡ä¸ä¸ºç©º
            if [[ -z "$VERSION" ]]; then
                echo "Error: Version not found in operator.yaml"
                exit 1
            fi
            # æž„å»º & æŽ¨é€ Docker é•œåƒ
            docker build -t fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:$VERSION operators/$OPERATOR/
            docker push fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:$VERSION


            # ä»ç„¶æŽ¨é€ä¸€ä¸ª latest æ ‡ç­¾
            docker tag fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:$VERSION fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:latest
            docker push fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:latest
          done

      - name: ðŸ”„ Update operators_list.json (After Push)
        run: |
          # è¯»å–çŽ°æœ‰ JSON æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          if [ ! -f operators_list.json ]; then
            echo "[]" > operators_list.json
          fi

          # æ›´æ–° JSON æ–‡ä»¶ï¼Œä¿æŒæœ€æ–°ç‰ˆæœ¬
          cat operators_list.json | jq --arg name "${{ env.operator }}" --arg version "${{ env.version }}" '
          map(if .name == $name then .version = $version else . end) +
          if map(.name) | index($name) then [] else [{"name": $name, "version": $version}] end' > tmp.json

          mv tmp.json operators_list.json
          
      - name: ðŸš€ Commit & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git add operators_list.json
          git commit -m "ðŸ”„ Update operator list: ${{ env.operator }} v${{ env.version }}" || echo "No changes to commit"
          git push
