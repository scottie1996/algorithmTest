name: Build & Push Operator Image

on:
  workflow_dispatch:  # ğŸ‘ˆ å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Detect Changed Operators
        id: detect_changes
        run: |
          echo "Detecting changed operators..."
          git fetch --depth=2
          CHANGED_OPERATORS=$(git diff --name-only HEAD~1 HEAD | grep '^operators/' | awk -F'/' '{print $2}' | sort -u)
          echo "Changed Operators: $CHANGED_OPERATORS"
          echo "changed_operators=${CHANGED_OPERATORS}" >> $GITHUB_ENV

      - name: ğŸ“¦ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ğŸš€ Build & Push Operators
        if: env.changed_operators != ''
        run: |
          for OPERATOR in ${{ env.changed_operators }}; do
            echo "Processing operator: $OPERATOR"

            # 1ï¸âƒ£ ç”Ÿæˆ requirements.txt
            echo "Generating requirements.txt from operator.xml..."
            # ä½¿ç”¨ xmllint æå– dependencies éƒ¨åˆ†
            xmllint --xpath "//tool/requirements/requirement" operators/$OPERATOR/operator.xml | sed 's/<requirement type="package">\([^<]*\)<\/requirement>/\1/g' > operators/$OPERATOR/requirements.txt
            cat operators/$OPERATOR/requirements.txt

            # 2ï¸âƒ£ å®‰è£…ä¾èµ–
            pip install -r operators/$OPERATOR/requirements.txt

            # 3ï¸âƒ£ Docker ç™»å½•
            echo "${{ secrets.HARBOR_PASSWORD }}" | docker login fairmarket.casdc.cn --username "${{ secrets.HARBOR_USER }}" --password-stdin

            # 4ï¸âƒ£ è¯»å– `operator.xml`ï¼Œè·å– OPERATOR_NAME å’Œ VERSION
            OPERATOR_NAME=$(xmllint --xpath "string(//tool/@id)" operators/$OPERATOR/operator.xml)
            echo "Extracted OPERATOR_NAME: $OPERATOR_NAME"

            VERSION=$(xmllint --xpath "string(//tool/version)" operators/$OPERATOR/operator.xml)
            if [[ -z "$VERSION" ]]; then
                echo "Error: Version not found
