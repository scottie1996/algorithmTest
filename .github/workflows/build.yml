name: Build & Push Operator Image

on:
  workflow_dispatch:  # ğŸ‘ˆ å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²

      - name: ğŸ” Detect Changed Operators
        id: detect_changes
        run: |
          echo "Detecting changed operators..."
          git fetch --depth=2
          CHANGED_OPERATORS=$(git diff --name-only HEAD~1 HEAD | grep '^operators/' | awk -F'/' '{print $2}' | sort -u)
          echo "Changed Operators: $CHANGED_OPERATORS"
          echo "changed_operators=${CHANGED_OPERATORS}" >> $GITHUB_ENV

      - name: ğŸ“¦ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ğŸ” Install XML Parser Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils  # å®‰è£… xmllint
          pip install xmltodict lxml
          
      - name: ğŸš€ Generate Dockerfile for Changed Operators
        run: |
          for OPERATOR in ${{ env.changed_operators }}; do
            echo "Generating Dockerfile for $OPERATOR..."
            python generate_dockerfile.py $OPERATOR

            cat operators/$OPERATOR/Dockerfile  # æ‰“å° Dockerfile çš„å†…å®¹
          done

      - name: ğŸš€ Build & Push Operators
        if: env.changed_operators != ''
        run: |
          for OPERATOR in ${{ env.changed_operators }}; do
            echo "Processing operator: $OPERATOR"

            XML_FILE="operators/$OPERATOR/$OPERATOR.xml"
            if [ ! -f "$XML_FILE" ]; then
                echo "Error: $XML_FILE not found!"
                exit 1
            fi

            # 1ï¸âƒ£ è§£æ XML æ–‡ä»¶ï¼Œæå–ä¾èµ–å’ŒåŸºç¡€é•œåƒ
            echo "Parsing XML file: $XML_FILE"

            OPERATOR_NAME=$(xmllint --xpath "string(//tool/@id)" $XML_FILE)
            VERSION=$(xmllint --xpath "string(//tool/@version)" $XML_FILE)
            BASE_IMAGE=$(xmllint --xpath "string(//container/docker/@image)" $XML_FILE)

            echo "Extracted OPERATOR_NAME: $OPERATOR_NAME"
            echo "Extracted VERSION: $VERSION"
            echo "Extracted BASE_IMAGE: $BASE_IMAGE"

            # 2ï¸âƒ£ ç”Ÿæˆ `requirements.txt`
            echo "Generating requirements.txt..."
            xmllint --xpath "//requirements/requirement/text()" $XML_FILE | tr ' ' '\n' > operators/$OPERATOR/requirements.txt
            cat operators/$OPERATOR/requirements.txt

            # 3ï¸âƒ£ å®‰è£… Python ä¾èµ–
            pip install -r operators/$OPERATOR/requirements.txt

            # 4ï¸âƒ£ Docker ç™»å½•
            echo "${{ secrets.HARBOR_PASSWORD }}" | docker login fairmarket.casdc.cn --username "${{ secrets.HARBOR_USER }}" --password-stdin

            # è§£æ CMD æŒ‡ä»¤ï¼Œè½¬æ¢ä¸º JSON æ ¼å¼
            CMD_COMMAND=$(xmllint --xpath "string(//command)" "$XML_FILE" | sed -E 's/\[CDATA\[|\]\]//g' | awk '{for (i=1; i<=NF; i++) printf "\"%s\"%s", $i, (i==NF?"":", ")}')
            CMD_COMMAND=$(echo "$CMD_COMMAND" | tr '\n' ' ')

            echo "CMD_COMMAND before Dockerfile generation: $CMD_COMMAND"
            
            echo "Generated Dockerfile for $OPERATOR:"
            echo "----------------------------------"
            cat operators/$OPERATOR/Dockerfile
            echo "----------------------------------"

            # 6ï¸âƒ£ æ„å»º & æ¨é€ Docker é•œåƒ
            docker build -t fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:$VERSION -f operators/$OPERATOR/Dockerfile operators/$OPERATOR/
            docker push fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:$VERSION

            # æ¨é€ `latest` ç‰ˆæœ¬
            docker tag fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:$VERSION fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:latest
            docker push fairmarket.casdc.cn/bigflow-unit/$OPERATOR_NAME:latest

            # 7ï¸âƒ£ æ›´æ–° `operators_list.json`
            echo "Updating operators_list.json..."
            if [ ! -f operators_list.json ]; then
              echo "[]" > operators_list.json
            fi

            cat operators_list.json | jq --arg name "$OPERATOR_NAME" --arg version "$VERSION" '
            map(if .name == $name then .version = $version else . end) +
            if map(.name) | index($name) then [] else [{"name": $name, "version": $version}] end' > tmp.json
            mv tmp.json operators_list.json

          done
      - name: ğŸ” Generate Operators List
        run: |
          python generate_operators_list.py
          echo "Generated operators_list.json:"
          cat operators_list.json  # æ‰“å° JSON ä»¥ä¾¿è°ƒè¯•
          

      - name: ğŸš€ Commit & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git add operators_list.json
          git commit -m "ğŸ”„ Update operator list" || echo "No changes to commit"
          git push
