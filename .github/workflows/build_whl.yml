name: Build & Upload Python Wheel

on:
  push:
    tags:
      - 'whl-v*'  # ä»…åœ¨æ‰“ç±»ä¼¼ whl-v0.1.0 è¿™æ ·çš„ tag æ—¶è§¦å‘

jobs:
  build_whl:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ðŸ“¦ Install wheel build tools
        run: pip install setuptools wheel

      - name: ðŸ›  Build wheel for operator_whl_test
        run: |
          cd operators_whl/operator_whl_test
          python setup.py bdist_wheel
          cd ../..

      - name: ðŸ“ Generate operators_list.json
        run: |
          PACKAGE_DIR="operators_whl/operator_whl_test"
          DIST_DIR="$PACKAGE_DIR/dist"
          WHL_FILE=$(ls $DIST_DIR/*.whl | head -n 1)
          if [ -z "$WHL_FILE" ]; then
            echo "No wheel file found!"
            exit 1
          fi
          WHL_FILENAME=$(basename $WHL_FILE)
          # æå–ç‰ˆæœ¬å·ï¼Œå‡è®¾æ–‡ä»¶åæ ¼å¼ï¼šname-version-py3-none-any.whl
          VERSION=$(echo $WHL_FILENAME | sed -E 's/^.*-([0-9]+\.[0-9]+\.[0-9]+)-.*$/\1/')

          echo "[{\"name\": \"operator_whl_test\", \"version\": \"$VERSION\"}]" > operators_list.json
          cat operators_list.json

      - name: ðŸš€ Upload .whl and operators_list.json to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            operators_whl/operator_whl_test/dist/*.whl
            operators_list.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
